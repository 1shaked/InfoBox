<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Image and Video Region Selector</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f2efe8;
      --ink: #1f1a16;
      --accent: #c0392b;
      --panel: #ffffff;
      --grid: #e0dbd3;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Georgia", "Times New Roman", serif;
      color: var(--ink);
      background: radial-gradient(circle at 20% 20%, #fff8e8 0%, var(--bg) 60%, #efe7dc 100%);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 32px;
    }

    .app {
      width: min(980px, 100%);
      background: var(--panel);
      border: 1px solid var(--grid);
      box-shadow: 0 18px 40px rgba(24, 19, 15, 0.15);
      padding: 24px;
    }

    h1 {
      margin: 0 0 12px 0;
      font-weight: 700;
      letter-spacing: 0.3px;
    }

    .controls {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 16px;
    }

    .coords {
      display: grid;
      grid-template-columns: repeat(4, minmax(80px, 1fr));
      gap: 12px;
      width: 100%;
    }

    .coords label {
      display: grid;
      gap: 6px;
      font-size: 0.9rem;
    }

    input[type="text"] {
      border: 1px solid var(--grid);
      padding: 8px;
      font-family: "Courier New", monospace;
      background: #fbfaf7;
    }

    .canvas-wrap {
      border: 1px solid var(--grid);
      background: repeating-linear-gradient(
        45deg,
        #f6f2ea,
        #f6f2ea 10px,
        #f0ebe3 10px,
        #f0ebe3 20px
      );
      display: grid;
      place-items: center;
      padding: 12px;
    }

    canvas {
      max-width: 100%;
      height: auto;
      display: block;
    }

    .hint {
      margin: 12px 0 0 0;
      font-size: 0.95rem;
      color: #5a5048;
    }

    .file-input {
      border: 1px dashed var(--grid);
      padding: 10px 14px;
      background: #fffaf0;
    }

    .url-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      width: 100%;
    }

    .url-input {
      flex: 1;
      min-width: 220px;
    }

    .button {
      border: 1px solid var(--grid);
      padding: 8px 14px;
      background: #fff4e4;
      font-family: inherit;
      cursor: pointer;
    }

    .timeline {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }

    .timeline input[type="range"] {
      flex: 1;
    }

    .timeline output {
      min-width: 70px;
      font-family: "Courier New", monospace;
      font-size: 0.9rem;
    }

    .button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .box-panel {
      margin: 16px 0 0 0;
      padding: 12px;
      border: 1px solid var(--grid);
      background: #fff8ec;
    }

    .box-panel h2 {
      margin: 0 0 8px 0;
      font-size: 1rem;
      letter-spacing: 0.2px;
    }

    .box-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .box-list {
      display: grid;
      gap: 8px;
    }

    .box-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border: 1px solid var(--grid);
      background: #ffffff;
      padding: 8px 10px;
    }

    .box-item.active {
      outline: 2px solid #2b90d9;
      border-color: #2b90d9;
    }

    .box-meta {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .swatch {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    .box-name {
      font-weight: 600;
    }

    .box-coords {
      font-family: "Courier New", monospace;
      font-size: 0.85rem;
      color: #5a5048;
    }

    #video {
      display: none;
    }

    @media (max-width: 720px) {
      body {
        padding: 16px;
      }

      .coords {
        grid-template-columns: repeat(2, minmax(80px, 1fr));
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <h1>Image and Video Region Selector</h1>
    <div class="controls">
      <label class="file-input">
        Upload image
        <input id="imageInput" type="file" accept="image/*" />
      </label>
      <label class="file-input">
        Upload video
        <input id="videoInput" type="file" accept="video/*" />
      </label>
      <div class="url-controls">
        <input id="mediaUrl" class="url-input" type="text" placeholder="Paste image or video URL" />
        <select id="urlType" class="button" aria-label="URL media type">
          <option value="auto">Auto-detect</option>
          <option value="image">Image</option>
          <option value="video">Video</option>
        </select>
        <button id="loadUrl" class="button" type="button">Load URL</button>
      </div>
      <button id="playVideo" class="button" type="button" disabled>Play</button>
      <button id="pauseVideo" class="button" type="button" disabled>Pause</button>
      <div class="timeline">
        <input id="videoSeek" type="range" min="0" max="0" step="0.01" value="0" disabled />
        <output id="videoTime">0:00</output>
      </div>
    </div>
    <div class="" style="display: flex; gap: 12px; align-items: center; margin: 5px;">
      <label>
        x1
        <input id="x1" type="text" readonly />
      </label>
      <label>
        y1
        <input id="y1" type="text" readonly />
      </label>
      <label>
        x2
        <input id="x2" type="text" readonly />
      </label>
      <label>
        y2
        <input id="y2" type="text" readonly />
      </label>
      <div>
        <button id="copy" class="button" type="button">
          copy coords
        </button>
      </div>
    </div>
    <div class="canvas-wrap">
      <canvas id="canvas" width="800" height="500"></canvas>
    </div>
    <section class="box-panel">
      <h2>Video boxes</h2>
      <div class="box-actions">
        <button id="addBox" class="button" type="button">Add box</button>
        <button id="deleteBox" class="button" type="button" disabled>Delete box</button>
      </div>
      <div id="boxList" class="box-list"></div>
    </section>
    <video id="video" playsinline></video>
    <p class="hint">Click and drag on the image or video frame to select an area. Each box has its own color.</p>
  </main>

  <script>
    const imageInput = document.getElementById("imageInput");
    const videoInput = document.getElementById("videoInput");
    const playButton = document.getElementById("playVideo");
    const pauseButton = document.getElementById("pauseVideo");
    const videoSeek = document.getElementById("videoSeek");
    const videoTime = document.getElementById("videoTime");
    const mediaUrlInput = document.getElementById("mediaUrl");
    const urlTypeSelect = document.getElementById("urlType");
    const loadUrlButton = document.getElementById("loadUrl");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const addBoxButton = document.getElementById("addBox");
    const deleteBoxButton = document.getElementById("deleteBox");
    const boxList = document.getElementById("boxList");
    const coordFields = {
      x1: document.getElementById("x1"),
      y1: document.getElementById("y1"),
      x2: document.getElementById("x2"),
      y2: document.getElementById("y2"),
    };

    let img = null;
    let mediaType = null;
    let currentVideoUrl = null;
    let renderFrameId = null;
    let isDragging = false;
    let start = null;
    let end = null;
    let activeBoxIndex = -1;
    let boxes = [];

    const boxColors = ["#b3392b", "#2b5bd9", "#2f8f4e", "#7a3fa0", "#8c5a2a", "#d4a62b"];

    const clamp = (value, min, max) => Math.min(Math.max(value, min), max);

    const clearCoords = () => {
      Object.values(coordFields).forEach((field) => {
        field.value = "";
      });
    };

    const stopAndClearVideo = () => {
      stopVideoRender();
      video.pause();
      video.removeAttribute("src");
      video.load();
      if (currentVideoUrl && currentVideoUrl.startsWith("blob:")) {
        URL.revokeObjectURL(currentVideoUrl);
      }
      currentVideoUrl = null;
    };

    const resetBoxesAndCanvas = () => {
      start = null;
      end = null;
      boxes = [];
      activeBoxIndex = -1;
      clearCoords();
      renderBoxList();
    };

    const formatCoords = (coords) => {
      if (!coords) return "â€”";
      const { x1, y1, x2, y2 } = coords;
      return `[${x1}, ${y1}, ${x2}, ${y2}]`;
    };

    const updateActiveBoxCoords = () => {
      if (!start || !end || activeBoxIndex === -1) return;
      const x1 = Math.round(Math.min(start.x, end.x));
      const y1 = Math.round(Math.min(start.y, end.y));
      const x2 = Math.round(Math.max(start.x, end.x));
      const y2 = Math.round(Math.max(start.y, end.y));
      boxes[activeBoxIndex].coords = { x1, y1, x2, y2 };
    };

    const syncCoordsFromActiveBox = () => {
      const box = boxes[activeBoxIndex];
      if (!box || !box.coords) {
        clearCoords();
        return;
      }
      coordFields.x1.value = box.coords.x1;
      coordFields.y1.value = box.coords.y1;
      coordFields.x2.value = box.coords.x2;
      coordFields.y2.value = box.coords.y2;
    };

    const selectBox = (index) => {
      activeBoxIndex = index;
      const box = boxes[activeBoxIndex];
      if (box && box.coords) {
        start = { x: box.coords.x1, y: box.coords.y1 };
        end = { x: box.coords.x2, y: box.coords.y2 };
      } else {
        start = null;
        end = null;
      }
      syncCoordsFromActiveBox();
      draw();
      renderBoxList();
    };

    const renderBoxList = () => {
      boxList.innerHTML = "";
      boxes.forEach((box, index) => {
        const row = document.createElement("div");
        row.className = "box-item";
        if (index === activeBoxIndex) row.classList.add("active");

        const meta = document.createElement("div");
        meta.className = "box-meta";

        const swatch = document.createElement("span");
        swatch.className = "swatch";
        swatch.style.background = box.color;

        const name = document.createElement("span");
        name.className = "box-name";
        name.textContent = box.name;

        const coords = document.createElement("span");
        coords.className = "box-coords";
        coords.textContent = formatCoords(box.coords);

        meta.appendChild(swatch);
        meta.appendChild(name);
        meta.appendChild(coords);

        const actions = document.createElement("div");
        actions.style.display = "flex";
        actions.style.gap = "2rem";
        
        const editButton = document.createElement("button");
        editButton.className = "button";
        editButton.type = "button";
        editButton.textContent = "Edit";
        editButton.addEventListener("click", () => {
          selectBox(index);
        });

        const copyButton = document.createElement("button");
        copyButton.className = "button";
        copyButton.type = "button";
        copyButton.textContent = "Copy Coords";
        copyButton.addEventListener("click", () => {
          if (box.coords) {
            const coordText = `[${box.coords.x1}, ${box.coords.y1}, ${box.coords.x2}, ${box.coords.y2}]`;
            navigator.clipboard.writeText(coordText).then(() => {
              alert(`Copied to clipboard: ${coordText}`);
            });
          } else {
            alert("No coordinates to copy.");
          }
        });

        actions.appendChild(copyButton);
        actions.appendChild(editButton);
        row.appendChild(meta);
        row.appendChild(actions);
        row.addEventListener("click", (event) => {
          if (event.target === editButton) return;
          selectBox(index);
        });
        boxList.appendChild(row);
      });

      deleteBoxButton.disabled = boxes.length === 0 || activeBoxIndex === -1;
    };

    const draw = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (mediaType === "image" && img) {
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      }
      if (mediaType === "video" && video.readyState >= 2) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      }
      boxes.forEach((box, index) => {
        if (!box.coords) return;
        const x = Math.min(box.coords.x1, box.coords.x2);
        const y = Math.min(box.coords.y1, box.coords.y2);
        const w = Math.abs(box.coords.x2 - box.coords.x1);
        const h = Math.abs(box.coords.y2 - box.coords.y1);
        ctx.fillStyle = `${box.color}33`;
        ctx.strokeStyle = box.color;
        ctx.lineWidth = index === activeBoxIndex ? 3 : 2;
        ctx.fillRect(x, y, w, h);
        ctx.strokeRect(x, y, w, h);
      });
    };

    const updateCoords = () => {
      if (!start || !end || activeBoxIndex === -1) {
        clearCoords();
        return;
      }
      updateActiveBoxCoords();
      syncCoordsFromActiveBox();
      renderBoxList();
    };

    const stopVideoRender = () => {
      if (renderFrameId !== null) {
        cancelAnimationFrame(renderFrameId);
        renderFrameId = null;
      }
    };

    const updatePlaybackControls = () => {
      const enabled = mediaType === "video" && video.readyState >= 2;
      playButton.disabled = !enabled;
      pauseButton.disabled = !enabled;
      videoSeek.disabled = !enabled;
    };

    const formatTime = (seconds) => {
      const safeSeconds = Math.max(0, Math.floor(seconds || 0));
      const minutes = Math.floor(safeSeconds / 60);
      const remainder = safeSeconds % 60;
      return `${minutes}:${String(remainder).padStart(2, "0")}`;
    };

    const getCanvasPoint = (event) => {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (event.clientX - rect.left) * scaleX;
      const y = (event.clientY - rect.top) * scaleY;
      return {
        x: clamp(x, 0, canvas.width),
        y: clamp(y, 0, canvas.height),
      };
    };

    canvas.addEventListener("mousedown", (event) => {
      if (!mediaType || activeBoxIndex === -1) return;
      isDragging = true;
      start = getCanvasPoint(event);
      end = start;
      updateCoords();
      draw();
    });

    canvas.addEventListener("mousemove", (event) => {
      if (!isDragging || !mediaType || activeBoxIndex === -1) return;
      end = getCanvasPoint(event);
      updateCoords();
      draw();
    });

    canvas.addEventListener("mouseup", () => {
      if (!mediaType || activeBoxIndex === -1) return;
      isDragging = false;
      updateCoords();
      draw();
    });

    canvas.addEventListener("mouseleave", () => {
      if (!mediaType || activeBoxIndex === -1) return;
      if (isDragging) {
        isDragging = false;
        updateCoords();
        draw();
      }
    });

    imageInput.addEventListener("change", (event) => {
      const [file] = event.target.files;
      if (!file) return;

      stopAndClearVideo();
      mediaType = "image";
      updatePlaybackControls();

      const reader = new FileReader();
      reader.onload = () => {
        const image = new Image();
        image.onload = () => {
          img = image;
          canvas.width = image.naturalWidth;
          canvas.height = image.naturalHeight;
          resetBoxesAndCanvas();
          draw();
        };
        image.src = reader.result;
      };
      reader.readAsDataURL(file);
    });

    videoInput.addEventListener("change", (event) => {
      const [file] = event.target.files;
      if (!file) return;

      stopAndClearVideo();
      currentVideoUrl = URL.createObjectURL(file);
      img = null;
      mediaType = "video";
      video.crossOrigin = "anonymous";
      video.src = currentVideoUrl;
      video.load();
    });

    video.addEventListener("loadedmetadata", () => {
      canvas.width = video.videoWidth || canvas.width;
      canvas.height = video.videoHeight || canvas.height;
      resetBoxesAndCanvas();
      videoSeek.min = "0";
      videoSeek.max = String(video.duration || 0);
      videoSeek.value = "0";
      videoTime.textContent = formatTime(0);
      updatePlaybackControls();
      draw();
    });

    video.addEventListener("error", () => {
      updatePlaybackControls();
      if (mediaType === "video") {
        alert("Could not load video from URL.");
      }
    });

    video.addEventListener("timeupdate", () => {
      videoSeek.value = String(video.currentTime || 0);
      videoTime.textContent = formatTime(video.currentTime);
      if (mediaType === "video" && video.paused) {
        draw();
      }
    });

    videoSeek.addEventListener("input", (event) => {
      if (mediaType !== "video") return;
      const nextTime = Number(event.target.value);
      if (!Number.isFinite(nextTime)) return;
      video.currentTime = nextTime;
      videoTime.textContent = formatTime(nextTime);
      draw();
    });

    const renderVideoFrame = () => {
      draw();
      if (mediaType === "video" && !video.paused && !video.ended) {
        renderFrameId = requestAnimationFrame(renderVideoFrame);
      } else {
        renderFrameId = null;
      }
    };

    playButton.addEventListener("click", () => {
      if (mediaType !== "video") return;
      video.play();
      renderVideoFrame();
    });

    pauseButton.addEventListener("click", () => {
      if (mediaType !== "video") return;
      video.pause();
      stopVideoRender();
      draw();
    });

    const loadImageFromUrl = (url) => {
      stopAndClearVideo();
      mediaType = "image";
      updatePlaybackControls();
      const image = new Image();
      image.crossOrigin = "anonymous";
      image.onload = () => {
        img = image;
        canvas.width = image.naturalWidth;
        canvas.height = image.naturalHeight;
        resetBoxesAndCanvas();
        draw();
      };
      image.onerror = () => {
        alert("Could not load image from URL.");
      };
      image.src = url;
    };

    const loadVideoFromUrl = (url) => {
      stopAndClearVideo();
      img = null;
      mediaType = "video";
      video.crossOrigin = "anonymous";
      video.src = url;
      video.load();
      updatePlaybackControls();
    };

    const loadUrl = () => {
      const url = (mediaUrlInput.value || "").trim();
      if (!url) {
        alert("Paste a URL first.");
        return;
      }
      const selectedType = urlTypeSelect.value;
      if (selectedType === "image") {
        loadImageFromUrl(url);
        return;
      }
      if (selectedType === "video") {
        loadVideoFromUrl(url);
        return;
      }
      const probeImage = new Image();
      probeImage.onload = () => {
        loadImageFromUrl(url);
      };
      probeImage.onerror = () => {
        loadVideoFromUrl(url);
      };
      probeImage.src = url;
    };

    loadUrlButton.addEventListener("click", loadUrl);
    mediaUrlInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        loadUrl();
      }
    });

    addBoxButton.addEventListener("click", () => {
      const nextIndex = boxes.length;
      const box = {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + nextIndex),
        name: `Box ${nextIndex + 1}`,
        color: boxColors[nextIndex % boxColors.length],
        coords: null,
      };
      boxes.push(box);
      selectBox(nextIndex);
    });

    deleteBoxButton.addEventListener("click", () => {
      if (activeBoxIndex === -1) return;
      boxes.splice(activeBoxIndex, 1);
      if (boxes.length === 0) {
        activeBoxIndex = -1;
        start = null;
        end = null;
        clearCoords();
      } else {
        const nextIndex = Math.max(0, activeBoxIndex - 1);
        selectBox(nextIndex);
      }
      renderBoxList();
      draw();
    });

    draw();
    renderBoxList();

    document.getElementById("copy").addEventListener("click", () => {
      const x1 = coordFields.x1.value;
      const y1 = coordFields.y1.value;
      const x2 = coordFields.x2.value;
      const y2 = coordFields.y2.value;
      if (x1 && y1 && x2 && y2) {
        const coordText = `[${x1}, ${y1}, ${x2}, ${y2}]`;
        navigator.clipboard.writeText(coordText).then(() => {
          alert(`Copied to clipboard: ${coordText}`);
        });
      } else {
        alert("No coordinates to copy.");
      }
    });
  </script>
</body>
</html>
